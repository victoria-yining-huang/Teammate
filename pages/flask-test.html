<html>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <body>
    <h1>
      This is a flask test.
    </h1>
    <button onclick="start()">
      Start Job
    </button>
    <button onclick="check()">
      Check Job
    </button>
    <button onclick="ping()">
      Ping Job
    </button>
  </body>
  <script>
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function timer(key) {
      await sleep(1000);
      check(key).then(function(resp) {
        if (resp["Status"] == "failed") {
          alert(resp["Message"]);
        } else {
          if (resp["Body"]["ModelIsFinished"]) {
            alert("DONE!");
          } else {
            console.log("!! model still running");
            timer(key);
          }
        }
      });
    }

    function start() {
      $.ajax({
        url: "/start-model",
        type: "post",
        success: function(resp) {
          console.log(resp);
          const key = resp["Key"];
          //sessionStorage.setItem("model_key", key);
          console.log("start timed checks");
          timer(key);
        }
      });
    }

    function check(key) {
      return new Promise(function(resolve) {
        $.ajax({
          url: "/status",
          type: "post",
          dataType: "json",
          contentType: "application/json",
          data: JSON.stringify({
            key: key
          }),
          success: function(resp) {
            console.log(resp);
            resolve(resp);
          }
        });
      });
    }

    function ping() {
      $.ajax({
        url: "/ping",
        type: "get",
        success: function(resp) {
          console.log(resp);
        }
      });
    }
  </script>
</html>
