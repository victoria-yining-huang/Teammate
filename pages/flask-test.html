<html>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <body>
    <h1>
      This is a flask test.
    </h1>
    <button onclick="start()">
      Start Job
    </button>
    <button onclick="check()">
      Check Job
    </button>
  </body>
  <script>
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function timer(key) {
      var stop = false;
      while (!stop) {
        await sleep(5000);
        check(key).then(function(resp) {
          if (resp["Status"] == "failed") {
            stop = true;
            alert(resp["Message"]);
          } else {
            if (resp["Body"]["ModelIsFinished"]) {
              stop = true;
              alert("DONE!");
            } else {
              console.log("!! model still running");
            }
          }
        });
      }
    }

    function start() {
      $.ajax({
        url: "/start-model",
        type: "post",
        success: function(resp) {
          console.log(resp);
          const key = resp["Key"];
          //sessionStorage.setItem("model_key", key);
          console.log("start timed checks");
          timer(key);
        }
      });
    }

    function check(key) {
      return new Promise(function(resolve) {
        $.ajax({
          url: "/status",
          type: "post",
          dataType: "json",
          contentType: "application/json",
          data: JSON.stringify({
            key: key
          }),
          success: function(resp) {
            console.log(resp);
            resolve(resp);
          }
        });
      });
    }
  </script>
</html>
